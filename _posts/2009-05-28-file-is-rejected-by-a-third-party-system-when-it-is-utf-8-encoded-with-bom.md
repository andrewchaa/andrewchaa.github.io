---
layout: post
title: File is rejected by a third-party system, when it is utf-8 encoded with BOM
date: 2009-05-28 10:00:05.000000000 +01:00
type: post
published: true
status: publish
categories:
- Programming
tags:
- c#
- DreamMail
- StreamWriter
meta:
  _edit_last: '1907066'
author:
  login: simplelifeuk
  email: andrew.chaa@yahoo.co.uk
  display_name: Andy
  first_name: Andrew
  last_name: Chaa
---
<p>Recently, I had a chance to refactor codes for a system that sends a file to DreamMail. Because we did not touch any FTP functionality, we were complacent and tested it up to where files are exported and sent via FTP. Development is completed and the application was deployed to a testing environment. Very thankfully and luckily, Jon (a team mate) and I happened to see that all new files generated by the refactored code are rejected in DreamMail ftp server. First we thought they fail because we use a testing account but it was worring that all files fail. We started investigating the issue. Picked one file that was successfully processed and uploaded it again. It worked without any problem. Then we compared the two files, successful one and failed one. Yet there was no difference. I assumed that something was different but was not visible, so downloaded <a href="http://www.ultraedit.com/index.html">Ultra-Edit</a> because it can display file in hex code and checked the two files. The difference was the first 3 characters which is called <a href="http://en.wikipedia.org/wiki/Byte-order_mark">BOM, Byte-Order Mark</a>.</p>
<p>BOM is zero-width, no-break space and therefore, not visible in most of text editor. "It is conventionally used as a marker to indicate that text is encoded in UTF-8, UTF-16 or UTF-32." (<a href="http://en.wikipedia.org/wiki/Byte-order_mark">wikipedia</a>) In hex value it is EF BB BF.</p>
<p>If the file stars with BOM, DreamMail client rejects it for some reason, thinking it is malformed.Â  My code that prepended BOM to the file was this.</p>
<p>[sourcecode language="C#"]<br />
using (StreamWriter sw = new StreamWriter(fs, Encoding.UTF8))<br />
[/sourcecode]</p>
<p>Fix for this is simple. Do not specify encoding in StreamWriter constructor.</p>
<p>[sourcecode language="C#"]<br />
using (StreamWriter sw = new StreamWriter(fs))<br />
[/sourcecode]</p>
<p>There is a post in Expert Exchange that tells you to use Encoding.ASCII. It fixes the problem, but all text will be written in ASCII. You will lose lots of characters.</p>
